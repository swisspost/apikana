#!/usr/bin/env node
var path = require('path');
var fs = require('fs');
var log = require('../src/log');
var colors = require('ansi-colors');
var params = require('../src/params');
var compareVersions = require('compare-versions');
var packge = require('../package.json');
var argc = process.argv.length;

require('../src/logo');

if (argc === 2) {
    help();
} else {
    if (params.minVersion() && compareVersions(params.minVersion(), packge.version) > 0) {
        log(colors.red('Expected minimum version'), params.minVersion(), colors.red('but current version is'), packge.version);
        log(colors.red('Please update the global apikana installation:'), 'npm install -g apikana');
        process.exit(1);
    }
    switch (process.argv[2]) {
    case 'init':
        require('../src/init/init');
        break;
    case 'start':
        generate();
        break;
    case 'stop':
        require('../src/server/stop').stop(params.port(), function () {
            log('Stopped');
        });
        break;
    case 'create-sample':
        createSample();
        break;
    case 'validate-samples':
        validateSamples();
        break;
    default:
        help();
        break;
    }
}

function help() {
    log(colors.magenta('apikana help'), '                             Show this help.');
    log(colors.magenta('apikana init'), '                             Initialize a new API project.');
    log(colors.magenta('apikana start'), colors.blue('[source]'), colors.red('[options]'), 'Generate JSON schemas and HTML documentation from the API.');
    log(colors.blue('               source'), '                    Directory containing the APIs and models. Default: src');
    log(colors.red('             --api=<file>'), '                The main api file (yaml or json). Default: openapi/api.yaml');
    log(colors.red('             --models=<path>'), '             The directory containing the models, if no api file is given. Default: ts');
    log(colors.red('             --style=<path>'), '              The directory containing css files for the swagger GUI. Default: style');
    log(colors.red('             --config=<file>'), '             Read additional options from a file in JSON format.');
    log(colors.red('             --javaPackage=<name>'), '        Java package to use.');
    log(colors.red('             --pathPrefix=<prefix>'), '       The common prefix for api paths to be used in generated *Paths files. Default: none');
    log(colors.red('             --basePath=<path>'), '           Override basePath specified in api file');
    log(colors.red('             --generate1stGenPaths=<boolean>'),'\n' +
                       '                                          Enable/disable generator for 1st generation path constants.\n' +
                       '                                          Since: v0.5.1\n' +
                       '                                          Default: true (enabled)');
    log(colors.red('             --generate2ndGenPaths=<boolean>'),'\n' +
                       '                                          Enable/disable generator for 2nd generation path constants.\n' +
                       '                                          Since: v0.5.1\n' +
                       '                                          Default: true (enabled)');
    log(colors.red('             --generate3rdGenPaths=<boolean>'),'\n' +
                       '                                          Enable/disable generator for 3rd generation path constants. This feature is\n' +
                       '                                          experimental! Therefore You\'ve to expect breaking changes when using it. May\n' +
                       '                                          this feature will become more stable in future and may the default will switch\n' +
                       '                                          to \'enabled\'.\n' +
                       '                                          Since: v0.5.0\n' +
                       '                                          Default: false (disabled)');
    log(colors.red('             --deploy=<boolean>'), '          If the sources should be copied into the target directory. Default: false');
    log(colors.red('             --dependencyPath=<path>'), '     Directory containing API dependencies. Default: node_modules/-api-dependencies');
    log(colors.red('             --port=<number>'), '             Port to serve the HTML documentation. Default: 8333');
    log(colors.red('             --serve=<boolean>'), '           If the HTML documentation should be served over HTTP. Default: true');
    log(colors.red('             --openBrowser=<boolean>'), '     If the browser should be opened at first start. Default: true');
    log(colors.red('             --minVersion=<version>'), '      Fail if the current apikana version is lower than expected.');
    log(colors.red('             --log=<level>'), '               Set log level (debug, info, warn, error). Default: info');
    log(colors.magenta('apikana stop '), colors.red('[options]'), '                  Stop a running server.');
    log(colors.red('             --port=<number>'), '             Port of the server to be stopped. Default: 8333');

    log(colors.magenta('apikana create-sample '), colors.red('[typeName]'), '        Generate samples for the space separated typeNames.');
    log(colors.magenta('apikana validate-samples'), '                 Validates the samples usind the available types.');
}

function createSample() {
    params.readConfigFile();
    require('../src/generate-sample').generateSample(path.resolve('src'), path.resolve(params.target()), process.argv.slice(3));
}

function validateSamples() {
    require('../src/validate-samples').validate(path.resolve('.'));
}

function generate() {
    var source = 'src';

    if (argc > 3 && process.argv[3].substring(0, 2) !== '--') {
        source = process.argv[3];
    }
    params.readConfigFile();

    log('Source: ', source);

    const nodePlop = require("node-plop");
    const registryUrl = require('registry-url');
    const os = require('os');
    const currentPath = process.cwd();
    const packageJSON = JSON.parse(fs.readFileSync(path.resolve(currentPath, './package.json')));

    const PluginManager = require('live-plugin-manager').PluginManager;
    const manager = new PluginManager({
        npmRegistryUrl: registryUrl(),
        pluginsPath: path.join(os.tmpdir(), 'apikana-plugin-packages')
    });

    function run(defaults) {
        var plop = nodePlop(__dirname + '/../src/plopfile_start.js', { defaults });
        var generator = plop.getGenerator('start');
        generator.runActions(packageJSON).then(_ => {
            require('../src/generate').generate(path.resolve(source), params.target());
        });
    }

    var defaultsVersion = packageJSON.devDependencies['apikana-defaults'];

    if (defaultsVersion) {
        if(defaultsVersion != "0.0.0") {
            process.stdout.write("Using defaults " + defaultsVersion + "\n");
        }
        var defaultsDir = path.join(process.cwd(), 'node_modules', 'apikana-defaults');
        var defaults = require(defaultsDir);
        defaults.dir = defaultsDir
        run(defaults);
    } else {
        process.stdout.write("Loading defaults... ");
        manager.install('apikana-defaults').then((e) => {
            process.stdout.write("found "+e.version+"\n");
            var defaults = manager.require('apikana-defaults');
            var defaultsDir = path.join(os.tmpdir(), 'apikana-plugin-packages', 'apikana-defaults');
            defaults.dir = defaultsDir;
            var version = JSON.parse(fs.readFileSync(path.join(defaultsDir, 'package.json'))).version;
            if(version != "0.0.0") {
                log(colors.yellow(`WARNING: | The build is unpredictable because of an implicit dependency.`));
                log(colors.yellow(`         | It may break anytime when a new version of the dependency is available in the registry.`));
                log(colors.yellow(`         | To fix this, freeze the dependency in your API project:`));
                log(colors.yellow(`         |  npm install apikana-defaults@${version} --save-dev`));
            }
            run(defaults);
        });
    }
}
